name: Rust
on:
  push:
  pull_request:
  schedule:
  - cron: '0 6 * * 0-6'
jobs:
  prepare_custom:
    runs-on: ubuntu-latest
    env:
      stuttgart_regbez_dir: 'custom/resources/stuttgart-regbez'
      stuttgart_regbez_url: https://download.geofabrik.de/europe/germany/baden-wuerttemberg/stuttgart-regbez-latest.osm.pbf
    steps:
    - name: Create custom directories
      run: |
        mkdir --parents --verbose "${stuttgart_regbez_dir}"
    - name: Download "${stuttgart_regbez_dir}/graph.osm.pbf"
      run: |
        wget -O "${stuttgart_regbez_dir}/graph.osm.pbf" "${stuttgart_regbez_url}"
    - name: Make data available in other jobs
      uses: actions/upload-artifact@v1
      with:
        name: custom
        path: custom
  foo:
    runs-on: ubuntu-latest
    needs: [prepare_custom]
    steps:
    - name: Download custom-directory
      uses: actions/download-artifact@v1
      with:
        name: custom
    - name: asdf
      run: |
        ls -al custom
        ls -al custom/resources/stuttgart-regbez
  stable:
    runs-on: ubuntu-latest
    needs: [prepare_custom]
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install toolchain
      run: |
        rustup component add rustfmt
    - name: Build
      run: |
        cargo build --verbose
        cargo build --release --verbose
    - name: Run tests
      run: |
        cargo test --verbose
        cargo fmt -- --check
    - name: Build docs
      run: cargo doc
  beta:
    runs-on: ubuntu-latest
    needs: [prepare_custom]
    steps:
    - uses: actions/checkout@v2
    - name: Install toolchain
      run: |
        rustup toolchain install beta
        rustup default beta
        rustup component add rustfmt
    - name: Build
      run: |
        cargo build --verbose
        cargo build --release --verbose
    - name: Run tests
      run: |
        cargo test --verbose
        cargo fmt -- --check
  nightly:
    runs-on: ubuntu-latest
    needs: [prepare_custom]
    steps:
    - uses: actions/checkout@v2
      continue-on-error: true
    - name: Install
      run: |
        rustup toolchain install nightly
        rustup default nightly
        rustup component add rustfmt
      continue-on-error: true
    - name: Build
      run: |
        cargo build --verbose
        cargo build --release --verbose
      continue-on-error: true
    - name: Run tests
      run: |
        cargo test --verbose
        cargo fmt -- --check
      continue-on-error: true
  benches:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Run benchmarks
      run: cargo bench
    - name: Prepare upload
      run: |
        artifacts="artifacts/$(git rev-parse --verify HEAD)"
        mkdir -p "${artifacts}"
        mv target/criterion/ "${artifacts}/"
    - name: Upload results
      uses: actions/upload-artifact@v1
      with:
        name: benches
        path: artifacts/
  deploy-and-tag:
    if: github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest
    needs: [stable, benches]
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup git-user
      env:
        GIT_USER_NAME: 'GitHub Actions'
        GIT_USER_EMAIL: 'actions@users.noreply.github.com'
      run: |
        git config --global user.name "${GIT_USER_NAME}"
        git config --global user.email "${GIT_USER_EMAIL}"
        git fetch --all
    - name: Deploy and tag
      env:
        CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}
      run: |
        cargo publish --token "${CRATES_TOKEN}"
        git tag --annotate "v$(cargo pkgid | cut -d# -f2 | cut -d: -f2)" --message='See CHANGELOG.md'
        git push --tags
